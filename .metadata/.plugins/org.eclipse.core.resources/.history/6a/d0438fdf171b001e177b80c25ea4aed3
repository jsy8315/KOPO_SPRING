package Command;

import java.io.IOException;
import java.util.ArrayList;

import dataControl.DAO;
import dataControl.DTO;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;

public class naverLoginCommand implements Command {
	String viewPage = null;
    String loggedInId = null;
    String password = null;;
    
    @Override
    public void execute(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // 네이버 로그인 처리 및 회원가입 절차를 구현해야 합니다.
        // 여기에 필요한 코드를 작성하시면 됩니다.
    	String id = (String) request.getAttribute("id");
    	String mail = (String) request.getAttribute("mail");
    	String name = (String) request.getAttribute("name");
        String cp = (String) request.getAttribute("cp");
        
        System.out.println(id + mail + name + cp);
        
        DAO memberDAO = DAO.getInstance(); // DAO 인스턴스 생성 방식 변경
        
        boolean customerExists = memberDAO.checkNaverLogin(cp);
        
        if (customerExists) {
        	//로그인 성공한걸로 간주하고 메인 페이지로 넘어감
        	loggedInId = id;
            HttpSession session = request.getSession();

            DTO dto = new DTO();
            DAO dao = DAO.getInstance();
            
            if (!"admin".equals(loggedInId)) {
                ArrayList<DTO> rs = dao.getLoggedInMember(loggedInId);
                
                if (!rs.isEmpty()) {
                    DTO member = rs.get(0);
                    session.setAttribute("loggedInId", loggedInId);
                    session.setAttribute("loggedIn", true);
                    session.setAttribute("isAdmin", false);     
                    System.out.println("로그인 완료");
                        viewPage = "Main.bank";
                } else {
                    System.out.println("없는 ID입니다.");
                }
                } else {
                ArrayList<DTO> rs = dao.getLoggedInAdmin(loggedInId);
                System.out.println("비었나 안비었나" + rs.isEmpty());
                System.out.println(rs.get(0).getId());

                if (!rs.isEmpty()) {
                    DTO admin = rs.get(0);
                    session.setAttribute("loggedInId", loggedInId);
                    session.setAttribute("loggedIn", true);
                    session.setAttribute("isAdmin", true);
                    viewPage = "Main.jsp";
                } else {
                    System.out.println("비밀번호가 일치하지 않습니다. 2번");
                }
                }
            }       	
        	
        else {
        	//네이버 프로필 값을 유지하고 naverJoinInput.jsp로 넘어감
            request.setAttribute("id", id);
            request.setAttribute("mail", mail);
            request.setAttribute("name", name);
            request.setAttribute("cp", cp);
        	viewPage="join/naverJoinInput.jsp";
        }
    }

    @Override
    public String getViewPage() {
        if (viewPage == null) {
            viewPage = "../error.jsp";
        }
        return viewPage;
    }
}
